{% extends "base.html" %}

{% block title %}Team Interface - Quiz System{% endblock %}

{% block content %}
<div class="team-interface">
    <div class="team-header">
        <h1 id="teamName">Team</h1>
        <button onclick="logout()" class="btn btn-danger btn-small">Logout</button>
    </div>

    <div class="round-display">
        <button id="currentRoundButton" class="round-button" type="button" disabled>Round: --</button>
    </div>

    <div class="status-panel">
        <div id="buzzerStatus" class="buzzer-status">Buzzer Ready</div>
        <div id="placementDisplay" class="placement-display"></div>
    </div>
</div>

<style>
    .team-interface {
        max-width: 520px;
        margin: 0 auto;
        padding: 20px;
        text-align: center;
    }

    .team-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        background: white;
        padding: 20px;
        border-radius: 10px;
    }

    .team-header h1 {
        margin: 0;
        color: #2c3e50;
        font-size: 1.8rem;
    }

    .btn-small {
        padding: 8px 16px;
        font-size: 0.9rem;
    }

    .round-display {
        margin-bottom: 25px;
    }

    .round-button {
        width: 100%;
        padding: 18px 20px;
        font-size: 1.2rem;
        font-weight: 700;
        border-radius: 10px;
        border: none;
        background: #2c3e50;
        color: white;
        cursor: default;
    }

    .round-button:disabled {
        opacity: 1;
    }

    .status-panel {
        background: white;
        padding: 20px;
        border-radius: 10px;
    }

    .buzzer-status {
        font-size: 1.1rem;
        min-height: 28px;
        color: #7f8c8d;
    }

    .placement-display {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 10px;
        margin-top: 15px;
        font-size: 1.2rem;
        font-weight: bold;
        color: #2c3e50;
        min-height: 50px;
    }

    .placement-1st {
        color: #f39c12;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    @media (max-width: 768px) {
        .team-interface {
            padding: 10px;
        }

        .round-button {
            font-size: 1.05rem;
        }
    }
</style>

<script>
let ws = null;
let sessionId = null;
let teamId = null;
let deviceId = null;
let buzzerLocked = false;
let teamInQueue = false;
let buzzPending = false;
let buzzPendingAt = null;

async function init() {
    try {
        const data = await apiRequest('/team/sessions/current');
        sessionId = data.session_id;
        teamId = data.team_id;
        document.getElementById('teamName').textContent = data.team_name;

        deviceId = 'device_' + Math.random().toString(36).substr(2, 9);

        await loadCurrentRound();
        connectWebSocket();
        window.addEventListener('keydown', handleKeydown);
    } catch (error) {
        showAlert('Error loading session: ' + error.message, 'error');
    }
}

async function loadCurrentRound() {
    const roundButton = document.getElementById('currentRoundButton');
    if (!roundButton || !sessionId) {
        return;
    }

    try {
        const snapshot = await apiRequest(`/display/sessions/${sessionId}/snapshot`);
        if (snapshot && snapshot.current_round && snapshot.current_round.name) {
            roundButton.textContent = `Round: ${snapshot.current_round.name}`;
        } else {
            roundButton.textContent = 'Round: --';
        }
    } catch (error) {
        roundButton.textContent = 'Round: --';
    }
}

function connectWebSocket() {
    ws = new WSConnection(`/ws/team/${sessionId}`);

    ws.on('open', () => {
        console.log('WebSocket connected');
    });

    ws.on('buzzer.status', (data) => {
        const statusDiv = document.getElementById('buzzerStatus');
        const placementDiv = document.getElementById('placementDisplay');

        buzzerLocked = !!data.locked;

        teamInQueue = false;
        let placement = null;

        if (data.queue && data.queue.length > 0 && teamId) {
            for (let i = 0; i < data.queue.length; i++) {
                if (data.queue[i].team_id === teamId) {
                    teamInQueue = true;
                    placement = i + 1;
                    break;
                }
            }
        }

        if (buzzerLocked) {
            statusDiv.textContent = 'Buzzer cooling down';
            statusDiv.style.color = '#f39c12';
            placementDiv.textContent = '';
            placementDiv.className = 'placement-display';
            buzzPending = false;
            buzzPendingAt = null;
            return;
        }

        if (teamInQueue) {
            statusDiv.textContent = 'Buzzed!';
            statusDiv.style.color = '#2ecc71';
            buzzPending = false;
            buzzPendingAt = null;

            const suffix = placement === 1 ? 'st' : placement === 2 ? 'nd' : placement === 3 ? 'rd' : 'th';
            placementDiv.textContent = `You are ${placement}${suffix} (${data.total_buzzers} total)`;
            placementDiv.className = 'placement-display';
            if (placement === 1) {
                placementDiv.classList.add('placement-1st');
            }
            return;
        }

        if (buzzPending && buzzPendingAt && Date.now() - buzzPendingAt > 2000) {
            buzzPending = false;
            buzzPendingAt = null;
        }

        statusDiv.textContent = buzzPending ? 'Buzzing...' : 'Buzzer Ready';
        statusDiv.style.color = buzzPending ? '#f39c12' : '#2ecc71';
        placementDiv.textContent = '';
        placementDiv.className = 'placement-display';
    });

    ws.on('buzz.confirmed', (data) => {
        const statusDiv = document.getElementById('buzzerStatus');
        const placementDiv = document.getElementById('placementDisplay');

        buzzPending = false;
        buzzPendingAt = null;
        teamInQueue = true;

        statusDiv.textContent = data.message || 'Buzz registered';
        statusDiv.style.color = '#2ecc71';

        if (data.placement) {
            const suffix = data.placement === 1 ? 'st' : data.placement === 2 ? 'nd' : data.placement === 3 ? 'rd' : 'th';
            placementDiv.textContent = `You are ${data.placement}${suffix} (${data.total_buzzers} total)`;
            placementDiv.className = 'placement-display';
            if (data.placement === 1) {
                placementDiv.classList.add('placement-1st');
            }
        }
    });

    ws.on('buzz.rejected', (data) => {
        const statusDiv = document.getElementById('buzzerStatus');
        buzzPending = false;
        buzzPendingAt = null;
        statusDiv.textContent = data.reason || 'Buzz rejected';
        statusDiv.style.color = '#e74c3c';
    });

    ws.on('buzzer.cleared', () => {
        const statusDiv = document.getElementById('buzzerStatus');
        const placementDiv = document.getElementById('placementDisplay');

        teamInQueue = false;
        buzzPending = false;
        buzzPendingAt = null;

        statusDiv.textContent = buzzerLocked ? 'Buzzer cooling down' : 'Buzzer Ready';
        statusDiv.style.color = buzzerLocked ? '#f39c12' : '#2ecc71';
        placementDiv.textContent = '';
        placementDiv.className = 'placement-display';
    });

    ws.connect();
}

function isBuzzerKey(event) {
    if (event.key >= '1' && event.key <= '9') {
        return true;
    }
    if (event.code && event.code.startsWith('Numpad')) {
        const digit = event.code.replace('Numpad', '');
        return digit >= '1' && digit <= '9';
    }
    return false;
}

function handleKeydown(event) {
    if (event.repeat) {
        return;
    }
    if (!isBuzzerKey(event)) {
        return;
    }
    if (buzzerLocked || teamInQueue || buzzPending) {
        return;
    }

    event.preventDefault();
    pressBuzzer();
}

async function pressBuzzer() {
    try {
        if (buzzerLocked || teamInQueue || buzzPending) {
            return;
        }

        buzzPending = true;
        buzzPendingAt = Date.now();
        const statusDiv = document.getElementById('buzzerStatus');
        statusDiv.textContent = 'Buzzing...';
        statusDiv.style.color = '#f39c12';

        if (ws && ws.ws && ws.ws.readyState === WebSocket.OPEN) {
            ws.send({
                action: 'buzz',
                device_id: deviceId
            });
        }
    } catch (error) {
        buzzPending = false;
        buzzPendingAt = null;
        showAlert('Error sending buzz: ' + error.message, 'error');
    }
}

function logout() {
    if (ws) {
        ws.close();
    }
    clearAuthToken();
    window.location.href = '/';
}

window.addEventListener('load', init);
</script>
{% endblock %}
