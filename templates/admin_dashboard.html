{% extends "base.html" %}

{% block title %}Admin Dashboard - Quiz System{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1>üë®‚Äçüíº Admin Dashboard</h1>
        <button onclick="logout()" class="btn btn-danger">Logout</button>
    </div>

    <div class="dashboard-content">
        <!-- Quick Actions -->
        <div class="card">
            <h2>Quick Actions</h2>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="showSection('teams')">Manage Teams</button>
                <button class="btn btn-primary" onclick="showSection('sessions')">Manage Sessions</button>
                <button class="btn btn-primary" onclick="showSection('slides')">Upload Slides</button>
                <button class="btn btn-primary" onclick="showSection('qm-users')">Create Quiz Master</button>
                <button class="btn btn-primary" onclick="showSection('settings')">üì° Display & Monitor</button>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings-section" class="section" style="display:none;">
            <div class="card">
                <h2>Display Settings</h2>
                <p class="info-text">Configure how slides are displayed on the main screen</p>

                <div class="form-group">
                    <label>Display Mode</label>
                    <select id="displayModeSelect" onchange="toggleScreenShareSettings()">
                        <option value="png_slides">PNG Slides (Default)</option>
                        <option value="screen_share">Screen Share (WebRTC)</option>
                    </select>
                </div>

                <div id="screenShareSettings" style="display:none;">
                    <div class="form-group">
                        <label>Frame Rate</label>
                        <select id="fpsSettingSelect">
                            <option value="5">5 FPS (Low bandwidth)</option>
                            <option value="10" selected>10 FPS (Recommended)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quality</label>
                        <select id="qualitySettingSelect">
                            <option value="0.5">Low Quality</option>
                            <option value="0.7" selected>Medium Quality</option>
                            <option value="0.9">High Quality</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-success" onclick="saveDisplaySettings()">Save Settings</button>

                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>Note:</strong> Screen share mode requires a presenter to share their screen.
                    PNG slides mode uses uploaded presentation files.
                </div>
            </div>

            <!-- WebRTC Signal Monitor -->
            <div class="card" style="margin-top: 20px;">
                <h2>üì° WebRTC Signal Monitor</h2>
                <p class="info-text">Real-time monitoring of screen sharing connections</p>

                <div class="signal-monitor">
                    <div class="monitor-row">
                        <div class="monitor-item">
                            <div class="monitor-label">Presenter Status</div>
                            <div id="presenterStatus" class="status-indicator status-disconnected">
                                <span class="status-dot"></span>
                                <span class="status-text">Disconnected</span>
                            </div>
                        </div>

                        <div class="monitor-item">
                            <div class="monitor-label">Display Screens</div>
                            <div id="displayCount" class="monitor-value">0 connected</div>
                        </div>
                    </div>

                    <div class="monitor-row">
                        <div class="monitor-item">
                            <div class="monitor-label">WebRTC Connection</div>
                            <div id="webrtcStatus" class="status-indicator status-disconnected">
                                <span class="status-dot"></span>
                                <span class="status-text">Not Connected</span>
                            </div>
                        </div>

                        <div class="monitor-item">
                            <div class="monitor-label">Streaming Quality</div>
                            <div id="streamQuality" class="monitor-value">
                                <div>Frame Rate: <span id="monitorFps">--</span> FPS</div>
                                <div>Resolution: <span id="monitorResolution">--</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="monitor-row">
                        <div class="monitor-item" style="flex: 1;">
                            <div class="monitor-label">Last Update</div>
                            <div id="lastUpdate" class="monitor-value">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teams Section -->
        <div id="teams-section" class="section" style="display:none;">
            <div class="card">
                <h2>Teams Management</h2>
                <button class="btn btn-success" onclick="showTeamForm()">+ Add New Team</button>

                <div id="teamForm" class="form-container" style="display:none;">
                    <h3>Add New Team</h3>
                    <form id="addTeamForm">
                        <div class="form-group">
                            <label>Team Name</label>
                            <input type="text" id="teamName" required>
                        </div>
                        <div class="form-group">
                            <label>Team Code</label>
                            <input type="text" id="teamCode" required style="text-transform:uppercase;">
                        </div>
                        <div class="form-group">
                            <label>Seat Order</label>
                            <input type="number" id="seatOrder">
                        </div>
                        <button type="submit" class="btn btn-success">Create Team</button>
                        <button type="button" class="btn btn-secondary" onclick="hideTeamForm()">Cancel</button>
                    </form>
                </div>

                <div id="teamsList"></div>
            </div>
        </div>

        <!-- Sessions Section -->
        <div id="sessions-section" class="section" style="display:none;">
            <div class="card">
                <h2>Sessions Management</h2>
                <button class="btn btn-success" onclick="showSessionForm()">+ Create New Session</button>

                <div id="sessionForm" class="form-container" style="display:none;">
                    <h3>Create New Session</h3>
                    <form id="addSessionForm">
                        <div class="form-group">
                            <label>Session Name</label>
                            <input type="text" id="sessionName" required>
                        </div>
                        <div class="form-group">
                            <label>Banner Text</label>
                            <input type="text" id="bannerText" value="AISMOC 2026 QUIZ">
                        </div>
                        <button type="submit" class="btn btn-success">Create Session</button>
                        <button type="button" class="btn btn-secondary" onclick="hideSessionForm()">Cancel</button>
                    </form>
                </div>

                <div id="sessionsList"></div>

                <!-- Session Management Panel -->
                <div id="sessionManagePanel" class="form-container" style="display:none; margin-top:20px;">
                    <h3 id="managePanelTitle">Manage Session</h3>

                    <div class="form-group">
                        <label>Session Status</label>
                        <select id="manageSessionStatus" class="form-control">
                            <option value="draft">üü° Draft (Preparing)</option>
                            <option value="live">üü¢ Live (Active)</option>
                            <option value="ended">üî¥ Ended (Finished)</option>
                        </select>
                        <small class="text-muted">Change status to control quiz lifecycle</small>
                    </div>

                    <div class="form-group">
                        <label>Assign Teams to Session</label>
                        <div id="teamCheckboxes" class="checkbox-group">
                            <p class="text-muted">Loading teams...</p>
                        </div>
                        <small class="text-muted">Select which teams will participate in this session</small>
                    </div>

                    <div style="margin-top:20px;">
                        <button class="btn btn-success" onclick="saveSessionSettings()">Save Changes</button>
                        <button class="btn btn-secondary" onclick="hideManagePanel()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Master Users Section -->
        <div id="qm-users-section" class="section" style="display:none;">
            <div class="card">
                <h2>Create Quiz Master User</h2>
                <form id="addQMForm">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="qmUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="qmPassword" required>
                    </div>
                    <button type="submit" class="btn btn-success">Create Quiz Master</button>
                </form>
            </div>

            <div class="card">
                <h2>Create Presenter User</h2>
                <p class="info-text">Presenters can share their screen to display PowerPoint presentations</p>
                <form id="addPresenterForm">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="presenterUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="presenterPassword" required>
                    </div>
                    <button type="submit" class="btn btn-success">Create Presenter</button>
                </form>
            </div>
        </div>

        <!-- Slides Management Section -->
        <div id="slides-section" class="section" style="display:none;">
            <div class="card">
                <h2>Slide Upload Management</h2>

                <div class="form-group">
                    <label>Select Session</label>
                    <select id="slideSessionSelect" onchange="loadSessionDecks()">
                        <option value="">-- Select a session --</option>
                    </select>
                </div>

                <div id="slideUploadArea" style="display:none;">
                    <h3>Upload Slides</h3>
                    <p class="text-muted">Upload PowerPoint files (.ppt or .pptx) for this session. You can upload separate question and answer decks.</p>

                    <div class="upload-container">
                        <div class="upload-box">
                            <h4>Question Deck</h4>
                            <form id="uploadQuestionDeckForm">
                                <input type="file" id="questionDeckFile" accept=".ppt,.pptx" required>
                                <button type="submit" class="btn btn-primary">Upload Question Deck</button>
                            </form>
                        </div>

                        <div class="upload-box">
                            <h4>Answer Deck</h4>
                            <form id="uploadAnswerDeckForm">
                                <input type="file" id="answerDeckFile" accept=".ppt,.pptx" required>
                                <button type="submit" class="btn btn-primary">Upload Answer Deck</button>
                            </form>
                        </div>
                    </div>

                    <div id="decksList" style="margin-top:30px;">
                        <h3>Uploaded Decks</h3>
                        <div id="decksContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .dashboard {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 10px;
    }

    .dashboard-header h1 {
        margin: 0;
        color: #2c3e50;
    }

    .dashboard-content {
        min-height: 500px;
    }

    .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .form-container {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        margin: 20px 0;
    }

    .section {
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .upload-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .upload-box {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 2px dashed #ddd;
    }

    .upload-box h4 {
        margin-top: 0;
        color: #2c3e50;
    }

    .upload-box input[type="file"] {
        display: block;
        width: 100%;
        margin: 15px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: white;
    }

    .text-muted {
        color: #7f8c8d;
        font-size: 0.9rem;
        margin: 10px 0;
    }

    .deck-item {
        background: white;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        border-left: 4px solid #3498db;
    }

    .deck-item h4 {
        margin: 0 0 10px 0;
        color: #2c3e50;
    }

    .deck-item p {
        margin: 5px 0;
        color: #7f8c8d;
        font-size: 0.9rem;
    }

    .checkbox-group {
        background: white;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #ddd;
        max-height: 300px;
        overflow-y: auto;
    }

    .checkbox-item {
        padding: 10px;
        margin: 5px 0;
        background: #f8f9fa;
        border-radius: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .checkbox-item:hover {
        background: #e9ecef;
    }

    .checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .checkbox-item label {
        margin: 0;
        cursor: pointer;
        flex: 1;
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
    }

    small.text-muted {
        display: block;
        margin-top: 5px;
        font-size: 0.85rem;
    }

    /* WebRTC Signal Monitor */
    .signal-monitor {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
    }

    .monitor-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .monitor-row:last-child {
        margin-bottom: 0;
    }

    .monitor-item {
        background: white;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
    }

    .monitor-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 8px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .monitor-value {
        font-size: 1.1rem;
        color: #2c3e50;
        font-weight: 500;
    }

    .monitor-value div {
        margin: 4px 0;
        font-size: 0.95rem;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1rem;
        font-weight: 600;
    }

    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        animation: pulse 2s infinite;
    }

    .status-connected .status-dot {
        background: #27ae60;
    }

    .status-disconnected .status-dot {
        background: #95a5a6;
        animation: none;
    }

    .status-error .status-dot {
        background: #e74c3c;
    }

    .status-connected .status-text {
        color: #27ae60;
    }

    .status-disconnected .status-text {
        color: #95a5a6;
    }

    .status-error .status-text {
        color: #e74c3c;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
        }
        50% {
            opacity: 0.6;
            transform: scale(1.1);
        }
    }
</style>

<script>
function showSection(section) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(s => s.style.display = 'none');

    // Show selected section
    document.getElementById(section + '-section').style.display = 'block';

    // Load data for section
    if (section === 'teams') {
        loadTeams();
    } else if (section === 'sessions') {
        loadSessions();
    } else if (section === 'slides') {
        loadSlideSessions();
    } else if (section === 'settings') {
        loadDisplaySettings();
    }
}

function showTeamForm() {
    document.getElementById('teamForm').style.display = 'block';
}

function hideTeamForm() {
    document.getElementById('teamForm').style.display = 'none';
    document.getElementById('addTeamForm').reset();
}

function showSessionForm() {
    document.getElementById('sessionForm').style.display = 'block';
}

function hideSessionForm() {
    document.getElementById('sessionForm').style.display = 'none';
    document.getElementById('addSessionForm').reset();
}

async function loadTeams() {
    try {
        const teams = await apiRequest('/admin/teams');
        const listDiv = document.getElementById('teamsList');

        if (teams.length === 0) {
            listDiv.innerHTML = '<p>No teams yet. Create your first team!</p>';
            return;
        }

        let html = '<table><thead><tr><th>Name</th><th>Code</th><th>Seat Order</th><th>Status</th></tr></thead><tbody>';
        teams.forEach(team => {
            html += `<tr>
                <td>${team.name}</td>
                <td><strong>${team.code}</strong></td>
                <td>${team.seat_order || '-'}</td>
                <td>${team.is_active ? '‚úì Active' : '‚úó Inactive'}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        listDiv.innerHTML = html;
    } catch (error) {
        showAlert('Error loading teams: ' + error.message, 'error');
    }
}

async function loadSessions() {
    try {
        const sessions = await apiRequest('/admin/sessions');
        const listDiv = document.getElementById('sessionsList');

        if (sessions.length === 0) {
            listDiv.innerHTML = '<p>No sessions yet. Create your first session!</p>';
            return;
        }

        let html = '<table><thead><tr><th>Name</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
        sessions.forEach(session => {
            const statusBadge = session.status === 'live' ? 'üü¢' : session.status === 'ended' ? 'üî¥' : 'üü°';
            html += `<tr>
                <td>${session.name}</td>
                <td>${statusBadge} <strong>${session.status}</strong></td>
                <td>${new Date(session.created_at).toLocaleDateString()}</td>
                <td>
                    <button class="btn btn-primary btn-small" onclick="manageSession(${session.id}, '${session.name}', '${session.status}')">Manage</button>
                    <button class="btn btn-secondary btn-small" onclick="viewSession(${session.id})">View</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        listDiv.innerHTML = html;
    } catch (error) {
        showAlert('Error loading sessions: ' + error.message, 'error');
    }
}

// Form submissions
document.getElementById('addTeamForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    try {
        await apiRequest('/admin/teams', {
            method: 'POST',
            body: JSON.stringify({
                name: document.getElementById('teamName').value,
                code: document.getElementById('teamCode').value.toUpperCase(),
                seat_order: parseInt(document.getElementById('seatOrder').value) || null
            })
        });

        showAlert('Team created successfully!', 'success');
        hideTeamForm();
        loadTeams();
    } catch (error) {
        showAlert('Error creating team: ' + error.message, 'error');
    }
});

document.getElementById('addSessionForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    try {
        await apiRequest('/admin/sessions', {
            method: 'POST',
            body: JSON.stringify({
                name: document.getElementById('sessionName').value,
                banner_text: document.getElementById('bannerText').value
            })
        });

        showAlert('Session created successfully!', 'success');
        hideSessionForm();
        loadSessions();
    } catch (error) {
        showAlert('Error creating session: ' + error.message, 'error');
    }
});

document.getElementById('addQMForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    try {
        await apiRequest('/admin/users/quiz-master', {
            method: 'POST',
            body: JSON.stringify({
                username: document.getElementById('qmUsername').value,
                password: document.getElementById('qmPassword').value
            })
        });

        showAlert('Quiz Master created successfully!', 'success');
        document.getElementById('addQMForm').reset();
    } catch (error) {
        showAlert('Error creating Quiz Master: ' + error.message, 'error');
    }
});

document.getElementById('addPresenterForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    try {
        await apiRequest('/admin/users/presenter', {
            method: 'POST',
            body: JSON.stringify({
                username: document.getElementById('presenterUsername').value,
                password: document.getElementById('presenterPassword').value
            })
        });

        showAlert('Presenter created successfully!', 'success');
        document.getElementById('addPresenterForm').reset();
    } catch (error) {
        showAlert('Error creating Presenter: ' + error.message, 'error');
    }
});

function viewSession(sessionId) {
    debug('Admin Dashboard: Redirecting to QM dashboard for session', sessionId);
    // Redirect to QM dashboard where session can be managed
    window.location.href = `/qm/dashboard`;
}

// ============ Session Management Functions ============

let currentManagingSessionId = null;

async function manageSession(sessionId, sessionName, sessionStatus) {
    debug('Admin Dashboard: Managing session', sessionId);
    currentManagingSessionId = sessionId;

    // Show the management panel
    document.getElementById('sessionManagePanel').style.display = 'block';
    document.getElementById('managePanelTitle').textContent = `Manage Session: ${sessionName}`;

    // Set current status
    document.getElementById('manageSessionStatus').value = sessionStatus;

    // Load teams and their assignment status
    try {
        // Load all teams
        const allTeams = await apiRequest('/admin/teams');

        // Load session snapshot to see which teams are assigned
        const snapshot = await apiRequest(`/display/sessions/${sessionId}/snapshot`);
        const assignedTeamIds = snapshot.scores ? snapshot.scores.map(s => s.team_id) : [];

        // Build checkbox list
        const container = document.getElementById('teamCheckboxes');
        if (allTeams.length === 0) {
            container.innerHTML = '<p class="text-muted">No teams available. Create teams first.</p>';
            return;
        }

        let html = '';
        allTeams.forEach(team => {
            const isChecked = assignedTeamIds.includes(team.id) ? 'checked' : '';
            html += `
                <div class="checkbox-item">
                    <input type="checkbox" id="team_${team.id}" value="${team.id}" ${isChecked}>
                    <label for="team_${team.id}">${team.name} (${team.code})</label>
                </div>
            `;
        });
        container.innerHTML = html;

        debug('Admin Dashboard: Loaded', allTeams.length, 'teams,', assignedTeamIds.length, 'assigned');

    } catch (error) {
        debugError('Admin Dashboard: Error loading session data:', error);
        showAlert('Error loading session data: ' + error.message, 'error');
    }
}

function hideManagePanel() {
    document.getElementById('sessionManagePanel').style.display = 'none';
    currentManagingSessionId = null;
}

async function saveSessionSettings() {
    if (!currentManagingSessionId) {
        showAlert('No session selected', 'error');
        return;
    }

    const newStatus = document.getElementById('manageSessionStatus').value;

    // Get selected team IDs
    const checkboxes = document.querySelectorAll('#teamCheckboxes input[type="checkbox"]:checked');
    const selectedTeamIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

    debug('Admin Dashboard: Saving session settings:', {
        sessionId: currentManagingSessionId,
        status: newStatus,
        teamIds: selectedTeamIds
    });

    try {
        // Update session status
        await apiRequest(`/admin/sessions/${currentManagingSessionId}`, {
            method: 'PATCH',
            body: JSON.stringify({ status: newStatus })
        });
        debug('Admin Dashboard: Session status updated to', newStatus);

        // Assign teams to session
        if (selectedTeamIds.length > 0) {
            await apiRequest(`/admin/sessions/${currentManagingSessionId}/teams`, {
                method: 'POST',
                body: JSON.stringify(selectedTeamIds)
            });
            debug('Admin Dashboard: Teams assigned:', selectedTeamIds);
        }

        showAlert('Session settings saved successfully!', 'success');
        hideManagePanel();
        loadSessions(); // Reload the list to show updated status

    } catch (error) {
        debugError('Admin Dashboard: Error saving session settings:', error);
        showAlert('Error saving settings: ' + error.message, 'error');
    }
}

// ============ Slide Management Functions ============

async function loadSlideSessions() {
    try {
        const sessions = await apiRequest('/admin/sessions');
        const select = document.getElementById('slideSessionSelect');

        // Clear existing options except the first one
        select.innerHTML = '<option value="">-- Select a session --</option>';

        sessions.forEach(session => {
            const option = document.createElement('option');
            option.value = session.id;
            option.textContent = `${session.name} (${session.status})`;
            select.appendChild(option);
        });
    } catch (error) {
        showAlert('Error loading sessions: ' + error.message, 'error');
    }
}

async function loadSessionDecks() {
    const sessionId = document.getElementById('slideSessionSelect').value;

    if (!sessionId) {
        document.getElementById('slideUploadArea').style.display = 'none';
        return;
    }

    document.getElementById('slideUploadArea').style.display = 'block';

    try {
        const decks = await apiRequest(`/admin/sessions/${sessionId}/decks`);
        const container = document.getElementById('decksContent');

        if (decks.length === 0) {
            container.innerHTML = '<p class="text-muted">No decks uploaded yet. Upload your PowerPoint files above.</p>';
            return;
        }

        let html = '';
        decks.forEach(deck => {
            html += `
                <div class="deck-item">
                    <h4>${deck.deck_type === 'question' ? 'üìä' : '‚úÖ'} ${deck.deck_type.toUpperCase()} Deck</h4>
                    <p><strong>File:</strong> ${deck.ppt_path.split('/').pop()}</p>
                    <p><strong>Slides:</strong> ${deck.slides ? deck.slides.length : 0} slides converted</p>
                </div>
            `;
        });
        container.innerHTML = html;
    } catch (error) {
        showAlert('Error loading decks: ' + error.message, 'error');
    }
}

async function uploadDeck(deckType) {
    const sessionId = document.getElementById('slideSessionSelect').value;
    const fileInput = document.getElementById(deckType + 'DeckFile');
    const file = fileInput.files[0];

    if (!file) {
        showAlert('Please select a file', 'error');
        return;
    }

    if (!sessionId) {
        showAlert('Please select a session first', 'error');
        return;
    }

    try {
        showAlert(`Uploading ${deckType} deck... This may take a minute.`, 'info');

        const formData = new FormData();
        formData.append('file', file);

        const token = getAuthToken();
        const response = await fetch(`${API_BASE}/admin/sessions/${sessionId}/decks?deck_type=${deckType}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        if (!response.ok) {
            const error = await response.json().catch(() => ({ detail: 'Upload failed' }));
            throw new Error(error.detail || 'Upload failed');
        }

        const result = await response.json();
        showAlert(`${deckType.charAt(0).toUpperCase() + deckType.slice(1)} deck uploaded successfully! ${result.slides.length} slides converted.`, 'success');

        // Clear the file input
        fileInput.value = '';

        // Reload decks list
        await loadSessionDecks();

    } catch (error) {
        showAlert('Error uploading deck: ' + error.message, 'error');
    }
}

// Form submission handlers for deck uploads
document.addEventListener('DOMContentLoaded', () => {
    const questionForm = document.getElementById('uploadQuestionDeckForm');
    const answerForm = document.getElementById('uploadAnswerDeckForm');

    if (questionForm) {
        questionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await uploadDeck('question');
        });
    }

    if (answerForm) {
        answerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await uploadDeck('answer');
        });
    }
});

// Toggle screen share settings visibility
function toggleScreenShareSettings() {
    const displayMode = document.getElementById('displayModeSelect').value;
    const screenShareSettings = document.getElementById('screenShareSettings');
    screenShareSettings.style.display = displayMode === 'screen_share' ? 'block' : 'none';
}

// Load display settings
async function loadDisplaySettings() {
    try {
        const response = await apiRequest('/admin/settings');
        const settings = await response.json();

        if (settings.display_mode) {
            document.getElementById('displayModeSelect').value = settings.display_mode;
            toggleScreenShareSettings();
        }
        if (settings.screen_share_fps) {
            document.getElementById('fpsSettingSelect').value = settings.screen_share_fps;
        }
        if (settings.screen_share_quality) {
            document.getElementById('qualitySettingSelect').value = settings.screen_share_quality;
        }
    } catch (error) {
        console.error('Failed to load display settings:', error);
    }
}

// Save display settings
async function saveDisplaySettings() {
    const displayMode = document.getElementById('displayModeSelect').value;
    const fps = document.getElementById('fpsSettingSelect').value;
    const quality = document.getElementById('qualitySettingSelect').value;

    try {
        // Update display mode
        await apiRequest(`/admin/settings/display_mode?value=${displayMode}`, {
            method: 'PUT'
        });

        // Update FPS setting
        await apiRequest(`/admin/settings/screen_share_fps?value=${fps}`, {
            method: 'PUT'
        });

        // Update quality setting
        await apiRequest(`/admin/settings/screen_share_quality?value=${quality}`, {
            method: 'PUT'
        });

        showAlert('Display settings saved successfully', 'success');
    } catch (error) {
        showAlert('Failed to save settings: ' + error.message, 'error');
    }
}

function logout() {
    clearAuthToken();
    window.location.href = '/';
}

// Check authentication on load
// WebRTC Signal Monitoring
let monitorWebSocket = null;
let monitorSessionId = null;

function initializeMonitor(sessionId) {
    monitorSessionId = sessionId;
    connectMonitorWebSocket();
}

function connectMonitorWebSocket() {
    if (!monitorSessionId) return;

    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const token = getAuthToken();
    const wsUrl = `${protocol}//${window.location.host}/ws/admin/${monitorSessionId}?token=${token}`;

    monitorWebSocket = new WebSocket(wsUrl);

    monitorWebSocket.onopen = () => {
        console.log('[Monitor] WebSocket connected');
    };

    monitorWebSocket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.event === 'presenter.status') {
            updatePresenterStatus(data);
        } else if (data.event === 'presenter.started') {
            updatePresenterStatusIndicator('connected', 'Presenting');
        } else if (data.event === 'presenter.stopped' || data.event === 'presenter.disconnected') {
            updatePresenterStatusIndicator('disconnected', 'Disconnected');
            updateWebRTCStatus('disconnected', 'Not Connected');
        }
    };

    monitorWebSocket.onclose = () => {
        console.log('[Monitor] WebSocket closed, reconnecting...');
        setTimeout(connectMonitorWebSocket, 3000);
    };
}

function updatePresenterStatus(data) {
    // Update presenter status
    const status = data.is_presenting ? 'connected' : 'disconnected';
    const text = data.is_presenting ? 'Presenting' : 'Disconnected';
    updatePresenterStatusIndicator(status, text);

    // Update WebRTC status
    if (data.webrtc_state === 'connected') {
        updateWebRTCStatus('connected', 'Connected');
    } else if (data.webrtc_state === 'failed') {
        updateWebRTCStatus('error', 'Failed');
    } else {
        updateWebRTCStatus('disconnected', data.webrtc_state || 'Connecting');
    }

    // Update quality info
    if (data.frame_rate) {
        document.getElementById('monitorFps').textContent = data.frame_rate;
    }
    if (data.resolution) {
        document.getElementById('monitorResolution').textContent = data.resolution;
    }

    // Update last update time
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
}

function updatePresenterStatusIndicator(status, text) {
    const indicator = document.getElementById('presenterStatus');
    indicator.className = `status-indicator status-${status}`;
    indicator.querySelector('.status-text').textContent = text;
}

function updateWebRTCStatus(status, text) {
    const indicator = document.getElementById('webrtcStatus');
    indicator.className = `status-indicator status-${status}`;
    indicator.querySelector('.status-text').textContent = text;
}

function updateDisplayCount(count) {
    document.getElementById('displayCount').textContent = `${count} connected`;
}

// Initialize monitor when settings section is shown
const originalShowSection = showSection;
showSection = function(section) {
    originalShowSection(section);
    if (section === 'settings' && !monitorSessionId) {
        // Get active session ID (you can modify this to select a specific session)
        initializeMonitor(1); // Default to session 1, or make this dynamic
    }
};

window.addEventListener('load', () => {
    const token = getAuthToken();
    if (!token) {
        window.location.href = '/admin/login';
    }
});
</script>
{% endblock %}
