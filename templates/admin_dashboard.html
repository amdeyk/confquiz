{% extends "base.html" %}

{% block title %}Admin Dashboard - Quiz System{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1>üë®‚Äçüíº Admin Dashboard</h1>
        <button onclick="logout()" class="btn btn-danger">Logout</button>
    </div>

    <div class="dashboard-content">
        <!-- Quick Actions -->
        <div class="card">
            <h2>Quick Actions</h2>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="showSection('teams')">Manage Teams</button>
                <button class="btn btn-primary" onclick="showSection('sessions')">Manage Sessions</button>
                <button class="btn btn-primary" onclick="showSection('slides')">Upload Slides</button>
                <button class="btn btn-primary" onclick="showSection('qm-users')">Create Quiz Master</button>
            </div>
        </div>

        <!-- Teams Section -->
        <div id="teams-section" class="section" style="display:none;">
            <div class="card">
                <h2>Teams Management</h2>
                <button class="btn btn-success" onclick="showTeamForm()">+ Add New Team</button>

                <div id="teamForm" class="form-container" style="display:none;">
                    <h3>Add New Team</h3>
                    <form id="addTeamForm">
                        <div class="form-group">
                            <label>Team Name</label>
                            <input type="text" id="teamName" required>
                        </div>
                        <div class="form-group">
                            <label>Team Code</label>
                            <input type="text" id="teamCode" required style="text-transform:uppercase;">
                        </div>
                        <div class="form-group">
                            <label>Seat Order</label>
                            <input type="number" id="seatOrder">
                        </div>
                        <button type="submit" class="btn btn-success">Create Team</button>
                        <button type="button" class="btn btn-secondary" onclick="hideTeamForm()">Cancel</button>
                    </form>
                </div>

                <div id="teamsList"></div>
            </div>
        </div>

        <!-- Sessions Section -->
        <div id="sessions-section" class="section" style="display:none;">
            <div class="card">
                <h2>Sessions Management</h2>
                <button class="btn btn-success" onclick="showSessionForm()">+ Create New Session</button>

                <div id="sessionForm" class="form-container" style="display:none;">
                    <h3>Create New Session</h3>
                    <form id="addSessionForm">
                        <div class="form-group">
                            <label>Session Name</label>
                            <input type="text" id="sessionName" required>
                        </div>
                        <div class="form-group">
                            <label>Banner Text</label>
                            <input type="text" id="bannerText" value="AISMOC 2026 QUIZ">
                        </div>
                        <button type="submit" class="btn btn-success">Create Session</button>
                        <button type="button" class="btn btn-secondary" onclick="hideSessionForm()">Cancel</button>
                    </form>
                </div>

                <div id="sessionsList"></div>

                <!-- Session Management Panel -->
                <div id="sessionManagePanel" class="form-container" style="display:none; margin-top:20px;">
                    <h3 id="managePanelTitle">Manage Session</h3>

                    <div class="form-group">
                        <label>Session Status</label>
                        <select id="manageSessionStatus" class="form-control">
                            <option value="draft">üü° Draft (Preparing)</option>
                            <option value="live">üü¢ Live (Active)</option>
                            <option value="ended">üî¥ Ended (Finished)</option>
                        </select>
                        <small class="text-muted">Change status to control quiz lifecycle</small>
                    </div>

                    <div class="form-group">
                        <label>Assign Teams to Session</label>
                        <div id="teamCheckboxes" class="checkbox-group">
                            <p class="text-muted">Loading teams...</p>
                        </div>
                        <small class="text-muted">Select which teams will participate in this session</small>
                    </div>

                    <div style="margin-top:20px;">
                        <button class="btn btn-success" onclick="saveSessionSettings()">Save Changes</button>
                        <button class="btn btn-secondary" onclick="hideManagePanel()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Master Users Section -->
        <div id="qm-users-section" class="section" style="display:none;">
            <div class="card">
                <h2>Create Quiz Master User</h2>
                <form id="addQMForm">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="qmUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="qmPassword" required>
                    </div>
                    <button type="submit" class="btn btn-success">Create Quiz Master</button>
                </form>
            </div>
        </div>

        <!-- Slides Management Section -->
        <div id="slides-section" class="section" style="display:none;">
            <div class="card">
                <h2>Slide Upload Management</h2>

                <div class="form-group">
                    <label>Select Session</label>
                    <select id="slideSessionSelect" onchange="loadSessionDecks()">
                        <option value="">-- Select a session --</option>
                    </select>
                </div>

                <div id="slideUploadArea" style="display:none;">
                    <h3>Upload Slides</h3>
                    <p class="text-muted">Upload PowerPoint files (.ppt or .pptx) for this session. You can upload separate question and answer decks.</p>

                    <div class="upload-container">
                        <div class="upload-box">
                            <h4>Question Deck</h4>
                            <form id="uploadQuestionDeckForm">
                                <input type="file" id="questionDeckFile" accept=".ppt,.pptx" required>
                                <button type="submit" class="btn btn-primary">Upload Question Deck</button>
                            </form>
                        </div>

                        <div class="upload-box">
                            <h4>Answer Deck</h4>
                            <form id="uploadAnswerDeckForm">
                                <input type="file" id="answerDeckFile" accept=".ppt,.pptx" required>
                                <button type="submit" class="btn btn-primary">Upload Answer Deck</button>
                            </form>
                        </div>
                    </div>

                    <div id="decksList" style="margin-top:30px;">
                        <h3>Uploaded Decks</h3>
                        <div id="decksContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .dashboard {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 10px;
    }

    .dashboard-header h1 {
        margin: 0;
        color: #2c3e50;
    }

    .dashboard-content {
        min-height: 500px;
    }

    .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }

    .form-container {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        margin: 20px 0;
    }

    .section {
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .upload-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .upload-box {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 2px dashed #ddd;
    }

    .upload-box h4 {
        margin-top: 0;
        color: #2c3e50;
    }

    .upload-box input[type="file"] {
        display: block;
        width: 100%;
        margin: 15px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: white;
    }

    .text-muted {
        color: #7f8c8d;
        font-size: 0.9rem;
        margin: 10px 0;
    }

    .deck-item {
        background: white;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        border-left: 4px solid #3498db;
    }

    .deck-item h4 {
        margin: 0 0 10px 0;
        color: #2c3e50;
    }

    .deck-item p {
        margin: 5px 0;
        color: #7f8c8d;
        font-size: 0.9rem;
    }

    .checkbox-group {
        background: white;
        padding: 15px;
        border-radius: 5px;
        border: 1px solid #ddd;
        max-height: 300px;
        overflow-y: auto;
    }

    .checkbox-item {
        padding: 10px;
        margin: 5px 0;
        background: #f8f9fa;
        border-radius: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .checkbox-item:hover {
        background: #e9ecef;
    }

    .checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .checkbox-item label {
        margin: 0;
        cursor: pointer;
        flex: 1;
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
    }

    small.text-muted {
        display: block;
        margin-top: 5px;
        font-size: 0.85rem;
    }
</style>

<script>
function showSection(section) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(s => s.style.display = 'none');

    // Show selected section
    document.getElementById(section + '-section').style.display = 'block';

    // Load data for section
    if (section === 'teams') {
        loadTeams();
    } else if (section === 'sessions') {
        loadSessions();
    } else if (section === 'slides') {
        loadSlideSessions();
    }
}

function showTeamForm() {
    document.getElementById('teamForm').style.display = 'block';
}

function hideTeamForm() {
    document.getElementById('teamForm').style.display = 'none';
    document.getElementById('addTeamForm').reset();
}

function showSessionForm() {
    document.getElementById('sessionForm').style.display = 'block';
}

function hideSessionForm() {
    document.getElementById('sessionForm').style.display = 'none';
    document.getElementById('addSessionForm').reset();
}

async function loadTeams() {
    try {
        const teams = await apiRequest('/admin/teams');
        const listDiv = document.getElementById('teamsList');

        if (teams.length === 0) {
            listDiv.innerHTML = '<p>No teams yet. Create your first team!</p>';
            return;
        }

        let html = '<table><thead><tr><th>Name</th><th>Code</th><th>Seat Order</th><th>Status</th></tr></thead><tbody>';
        teams.forEach(team => {
            html += `<tr>
                <td>${team.name}</td>
                <td><strong>${team.code}</strong></td>
                <td>${team.seat_order || '-'}</td>
                <td>${team.is_active ? '‚úì Active' : '‚úó Inactive'}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        listDiv.innerHTML = html;
    } catch (error) {
        showAlert('Error loading teams: ' + error.message, 'error');
    }
}

async function loadSessions() {
    try {
        const sessions = await apiRequest('/admin/sessions');
        const listDiv = document.getElementById('sessionsList');

        if (sessions.length === 0) {
            listDiv.innerHTML = '<p>No sessions yet. Create your first session!</p>';
            return;
        }

        let html = '<table><thead><tr><th>Name</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
        sessions.forEach(session => {
            const statusBadge = session.status === 'live' ? 'üü¢' : session.status === 'ended' ? 'üî¥' : 'üü°';
            html += `<tr>
                <td>${session.name}</td>
                <td>${statusBadge} <strong>${session.status}</strong></td>
                <td>${new Date(session.created_at).toLocaleDateString()}</td>
                <td>
                    <button class="btn btn-primary btn-small" onclick="manageSession(${session.id}, '${session.name}', '${session.status}')">Manage</button>
                    <button class="btn btn-secondary btn-small" onclick="viewSession(${session.id})">View</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        listDiv.innerHTML = html;
    } catch (error) {
        showAlert('Error loading sessions: ' + error.message, 'error');
    }
}

// Form submissions
document.getElementById('addTeamForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    try {
        await apiRequest('/admin/teams', {
            method: 'POST',
            body: JSON.stringify({
                name: document.getElementById('teamName').value,
                code: document.getElementById('teamCode').value.toUpperCase(),
                seat_order: parseInt(document.getElementById('seatOrder').value) || null
            })
        });

        showAlert('Team created successfully!', 'success');
        hideTeamForm();
        loadTeams();
    } catch (error) {
        showAlert('Error creating team: ' + error.message, 'error');
    }
});

document.getElementById('addSessionForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    try {
        await apiRequest('/admin/sessions', {
            method: 'POST',
            body: JSON.stringify({
                name: document.getElementById('sessionName').value,
                banner_text: document.getElementById('bannerText').value
            })
        });

        showAlert('Session created successfully!', 'success');
        hideSessionForm();
        loadSessions();
    } catch (error) {
        showAlert('Error creating session: ' + error.message, 'error');
    }
});

document.getElementById('addQMForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    try {
        await apiRequest('/admin/users/quiz-master', {
            method: 'POST',
            body: JSON.stringify({
                username: document.getElementById('qmUsername').value,
                password: document.getElementById('qmPassword').value
            })
        });

        showAlert('Quiz Master created successfully!', 'success');
        document.getElementById('addQMForm').reset();
    } catch (error) {
        showAlert('Error creating Quiz Master: ' + error.message, 'error');
    }
});

function viewSession(sessionId) {
    debug('Admin Dashboard: Redirecting to QM dashboard for session', sessionId);
    // Redirect to QM dashboard where session can be managed
    window.location.href = `/qm/dashboard`;
}

// ============ Session Management Functions ============

let currentManagingSessionId = null;

async function manageSession(sessionId, sessionName, sessionStatus) {
    debug('Admin Dashboard: Managing session', sessionId);
    currentManagingSessionId = sessionId;

    // Show the management panel
    document.getElementById('sessionManagePanel').style.display = 'block';
    document.getElementById('managePanelTitle').textContent = `Manage Session: ${sessionName}`;

    // Set current status
    document.getElementById('manageSessionStatus').value = sessionStatus;

    // Load teams and their assignment status
    try {
        // Load all teams
        const allTeams = await apiRequest('/admin/teams');

        // Load session snapshot to see which teams are assigned
        const snapshot = await apiRequest(`/display/sessions/${sessionId}/snapshot`);
        const assignedTeamIds = snapshot.scores ? snapshot.scores.map(s => s.team_id) : [];

        // Build checkbox list
        const container = document.getElementById('teamCheckboxes');
        if (allTeams.length === 0) {
            container.innerHTML = '<p class="text-muted">No teams available. Create teams first.</p>';
            return;
        }

        let html = '';
        allTeams.forEach(team => {
            const isChecked = assignedTeamIds.includes(team.id) ? 'checked' : '';
            html += `
                <div class="checkbox-item">
                    <input type="checkbox" id="team_${team.id}" value="${team.id}" ${isChecked}>
                    <label for="team_${team.id}">${team.name} (${team.code})</label>
                </div>
            `;
        });
        container.innerHTML = html;

        debug('Admin Dashboard: Loaded', allTeams.length, 'teams,', assignedTeamIds.length, 'assigned');

    } catch (error) {
        debugError('Admin Dashboard: Error loading session data:', error);
        showAlert('Error loading session data: ' + error.message, 'error');
    }
}

function hideManagePanel() {
    document.getElementById('sessionManagePanel').style.display = 'none';
    currentManagingSessionId = null;
}

async function saveSessionSettings() {
    if (!currentManagingSessionId) {
        showAlert('No session selected', 'error');
        return;
    }

    const newStatus = document.getElementById('manageSessionStatus').value;

    // Get selected team IDs
    const checkboxes = document.querySelectorAll('#teamCheckboxes input[type="checkbox"]:checked');
    const selectedTeamIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

    debug('Admin Dashboard: Saving session settings:', {
        sessionId: currentManagingSessionId,
        status: newStatus,
        teamIds: selectedTeamIds
    });

    try {
        // Update session status
        await apiRequest(`/admin/sessions/${currentManagingSessionId}`, {
            method: 'PATCH',
            body: JSON.stringify({ status: newStatus })
        });
        debug('Admin Dashboard: Session status updated to', newStatus);

        // Assign teams to session
        if (selectedTeamIds.length > 0) {
            await apiRequest(`/admin/sessions/${currentManagingSessionId}/teams`, {
                method: 'POST',
                body: JSON.stringify(selectedTeamIds)
            });
            debug('Admin Dashboard: Teams assigned:', selectedTeamIds);
        }

        showAlert('Session settings saved successfully!', 'success');
        hideManagePanel();
        loadSessions(); // Reload the list to show updated status

    } catch (error) {
        debugError('Admin Dashboard: Error saving session settings:', error);
        showAlert('Error saving settings: ' + error.message, 'error');
    }
}

// ============ Slide Management Functions ============

async function loadSlideSessions() {
    try {
        const sessions = await apiRequest('/admin/sessions');
        const select = document.getElementById('slideSessionSelect');

        // Clear existing options except the first one
        select.innerHTML = '<option value="">-- Select a session --</option>';

        sessions.forEach(session => {
            const option = document.createElement('option');
            option.value = session.id;
            option.textContent = `${session.name} (${session.status})`;
            select.appendChild(option);
        });
    } catch (error) {
        showAlert('Error loading sessions: ' + error.message, 'error');
    }
}

async function loadSessionDecks() {
    const sessionId = document.getElementById('slideSessionSelect').value;

    if (!sessionId) {
        document.getElementById('slideUploadArea').style.display = 'none';
        return;
    }

    document.getElementById('slideUploadArea').style.display = 'block';

    try {
        const decks = await apiRequest(`/admin/sessions/${sessionId}/decks`);
        const container = document.getElementById('decksContent');

        if (decks.length === 0) {
            container.innerHTML = '<p class="text-muted">No decks uploaded yet. Upload your PowerPoint files above.</p>';
            return;
        }

        let html = '';
        decks.forEach(deck => {
            html += `
                <div class="deck-item">
                    <h4>${deck.deck_type === 'question' ? 'üìä' : '‚úÖ'} ${deck.deck_type.toUpperCase()} Deck</h4>
                    <p><strong>File:</strong> ${deck.ppt_path.split('/').pop()}</p>
                    <p><strong>Slides:</strong> ${deck.slides ? deck.slides.length : 0} slides converted</p>
                </div>
            `;
        });
        container.innerHTML = html;
    } catch (error) {
        showAlert('Error loading decks: ' + error.message, 'error');
    }
}

async function uploadDeck(deckType) {
    const sessionId = document.getElementById('slideSessionSelect').value;
    const fileInput = document.getElementById(deckType + 'DeckFile');
    const file = fileInput.files[0];

    if (!file) {
        showAlert('Please select a file', 'error');
        return;
    }

    if (!sessionId) {
        showAlert('Please select a session first', 'error');
        return;
    }

    try {
        showAlert(`Uploading ${deckType} deck... This may take a minute.`, 'info');

        const formData = new FormData();
        formData.append('file', file);

        const token = getAuthToken();
        const response = await fetch(`${API_BASE}/admin/sessions/${sessionId}/decks?deck_type=${deckType}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        if (!response.ok) {
            const error = await response.json().catch(() => ({ detail: 'Upload failed' }));
            throw new Error(error.detail || 'Upload failed');
        }

        const result = await response.json();
        showAlert(`${deckType.charAt(0).toUpperCase() + deckType.slice(1)} deck uploaded successfully! ${result.slides.length} slides converted.`, 'success');

        // Clear the file input
        fileInput.value = '';

        // Reload decks list
        await loadSessionDecks();

    } catch (error) {
        showAlert('Error uploading deck: ' + error.message, 'error');
    }
}

// Form submission handlers for deck uploads
document.addEventListener('DOMContentLoaded', () => {
    const questionForm = document.getElementById('uploadQuestionDeckForm');
    const answerForm = document.getElementById('uploadAnswerDeckForm');

    if (questionForm) {
        questionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await uploadDeck('question');
        });
    }

    if (answerForm) {
        answerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await uploadDeck('answer');
        });
    }
});

function logout() {
    clearAuthToken();
    window.location.href = '/';
}

// Check authentication on load
window.addEventListener('load', () => {
    const token = getAuthToken();
    if (!token) {
        window.location.href = '/admin/login';
    }
});
</script>
{% endblock %}
