{% extends "base.html" %}

{% block title %}Main Display - Quiz System{% endblock %}

{% block content %}
<div class="main-display">
    <div class="display-grid">
        <!-- Side Panel (Left) -->
        <div class="side-panel">
            <h1 id="bannerText" class="banner-text-hidden">AISMOC 2026 QUIZ</h1>
            <div class="sound-control">
                <button id="enableSoundBtn" class="enable-sound-btn" type="button">Enable Buzzer Sound</button>
            </div>

            <!-- Timer -->
            <div class="timer-card">
                <h3>Timer</h3>
                <div id="timerDisplay" class="timer-value">--:--</div>
                <div id="timerStatus" class="timer-status"></div>
            </div>

            <!-- Scoreboard -->
            <div class="scoreboard-card">
                <h3>Scores</h3>
                <table id="scoreboardTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Team</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody id="scoreboardBody">
                        <tr>
                            <td colspan="3">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Buzzer Queue -->
            <div class="buzzer-card">
                <h3>Buzzer Queue</h3>
                <div id="buzzerQueue">
                    <div class="no-buzzes">No buzzes yet</div>
                </div>
            </div>
        </div>

        <!-- Blank Main Area (Presenter/Slide view disabled) -->
        <div class="slide-area">
            <div id="slideContainer" class="slide-container">
                <div class="no-slide">No slide loaded</div>
            </div>
            <video id="screenShareVideo" class="screen-share-video" autoplay playsinline muted></video>
        </div>
    </div>
</div>

<style>
    * {
        box-sizing: border-box;
    }

    body {
        background: #fff;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .main-display {
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .banner-text-hidden {
        display: none;
    }

    .display-grid {
        display: grid;
        grid-template-columns: 18% 82%;
        gap: 0;
        padding: 0;
        flex: 1;
        overflow: hidden;
        min-height: 0;
    }

    .slide-area {
        background: white;
        overflow: hidden;
        min-height: 0;
        min-width: 0;
    }

    .slide-container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
    }

    .slide-container img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
    }

    .no-slide {
        color: #95a5a6;
        font-size: 1.5rem;
    }

    .screen-share-video {
        display: none;
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .screen-share-video.active {
        display: block;
    }

    .slide-container.hidden {
        display: none;
    }

    .side-panel {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 10px;
        background: #fff;
        overflow: hidden;
        min-height: 0;
    }

    .sound-control {
        flex-shrink: 0;
    }

    .enable-sound-btn {
        width: 100%;
        border: 0;
        border-radius: 8px;
        padding: 8px 10px;
        background: #1f2937;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
    }

    .timer-card,
    .scoreboard-card,
    .buzzer-card {
        background: white;
        border-radius: 8px;
        padding: 10px;
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .timer-card {
        text-align: center;
        flex-shrink: 0;
    }

    .timer-card h3 {
        margin-bottom: 10px;
        color: #2c3e50;
    }

    .timer-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #e74c3c;
        font-family: 'Courier New', monospace;
        line-height: 1;
    }

    .timer-status {
        font-size: 1rem;
        color: #7f8c8d;
        margin-top: 8px;
    }

    .scoreboard-card {
        flex: 1;
        overflow: hidden;
        min-height: 0;
        display: flex;
        flex-direction: column;
    }

    .scoreboard-card h3 {
        margin: 0 0 8px 0;
        color: #2c3e50;
        font-size: 1rem;
    }

    #scoreboardTable {
        width: 100%;
        font-size: 0.76rem;
        table-layout: fixed;
    }

    #scoreboardTable th {
        background: #ecf0f1;
        padding: 5px 4px;
        text-align: left;
    }

    #scoreboardTable td {
        padding: 5px 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .current-team {
        background: #fff3cd;
        font-weight: bold;
    }

    .buzzer-card {
        flex: 1;
        min-height: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .buzzer-card h3 {
        margin: 0 0 8px 0;
        color: #2c3e50;
        font-size: 1rem;
    }

    #buzzerQueue {
        min-height: 0;
        overflow-y: auto;
    }

    .buzzer-item {
        padding: 6px 7px;
        margin-bottom: 4px;
        border-radius: 5px;
        background: #ecf0f1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.78rem;
    }

    .buzzer-item.first {
        background: #f39c12;
        color: white;
        font-weight: bold;
    }

    .no-buzzes {
        color: #95a5a6;
        text-align: center;
        padding: 15px;
        font-size: 0.9rem;
    }

    /* Keep display logic running but hide all presentation content */
    .slide-container,
    .screen-share-video {
        display: none !important;
    }

    /* Ensure no horizontal scroll */
    .container {
        max-width: 100vw;
        overflow-x: hidden;
    }

    /* Mobile/Tablet - redirect message */
    @media (max-width: 1024px) {
        .main-display {
            display: flex !important;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }

        .display-grid {
            display: none !important;
        }

        .main-display::before {
            content: "⚠️ Main Display\A\APlease open this page on a laptop or desktop computer.\A\AThis screen requires a larger display.";
            white-space: pre-wrap;
            color: white;
            font-size: 1.5rem;
            background: rgba(0, 0, 0, 0.8);
            padding: 40px;
            border-radius: 10px;
            max-width: 90vw;
        }
    }

    /* Prevent any overflow on large screens */
    @media (min-width: 1025px) {
        html, body {
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
    }
</style>

<script src="/static/js/livekit-client.min.js"></script>
<script>
  window.livekit = window.livekit || window.LiveKitClient || window.LivekitClient || window.LiveKit;
  let ws = null;
let sessionId = null;
let displayMode = 'png_slides'; // Default mode
let livekitRoom = null;
let livekitTrack = null;
  let displayRole = 'normal';
  let lastJoinRequest = 0;
let lastInboundBytes = null;
let lastInboundTimestamp = null;
let pendingLivekitToken = null;
let pendingLivekitUrl = null;
let buzzerSound = null;
let lastFirstBuzzKey = null;
const displayId = 'display_' + Math.random().toString(36).substr(2, 9);

async function loadDisplayMode() {
    // Presenter rendering is intentionally disabled for main display.
    displayMode = 'png_slides';
}

function initBuzzerSound() {
    buzzerSound = new Audio('/media/freesound_community-error-83494.mp3');
    buzzerSound.preload = 'auto';
    buzzerSound.volume = 1.0;

    const btn = document.getElementById('enableSoundBtn');
    if (btn) {
        btn.addEventListener('click', () => {
            void enableBuzzerSound();
        });
    }

    window.addEventListener('pointerdown', () => {
        void enableBuzzerSound();
    }, { once: true });
}

async function enableBuzzerSound() {
    if (!buzzerSound) {
        return;
    }

    try {
        const originalVolume = buzzerSound.volume;
        buzzerSound.volume = 0;
        buzzerSound.currentTime = 0;
        await buzzerSound.play();
        buzzerSound.pause();
        buzzerSound.currentTime = 0;
        buzzerSound.volume = originalVolume;

        const btn = document.getElementById('enableSoundBtn');
        if (btn) {
            btn.style.display = 'none';
        }
    } catch (error) {
        const btn = document.getElementById('enableSoundBtn');
        if (btn) {
            btn.style.display = 'block';
        }
    }
}

async function playFirstBuzzerSound(eventData) {
    if (!eventData || eventData.placement !== 1 || !buzzerSound) {
        return;
    }

    const key = `${eventData.team_id || 'team'}:${eventData.timestamp || ''}`;
    if (key === lastFirstBuzzKey) {
        return;
    }
    lastFirstBuzzKey = key;

    try {
        buzzerSound.currentTime = 0;
        await buzzerSound.play();
    } catch (error) {
        const btn = document.getElementById('enableSoundBtn');
        if (btn) {
            btn.style.display = 'block';
        }
    }
}

function normalizeStats(reports) {
    const all = [];
    if (!reports) {
        return all;
    }
    const reportList = Array.isArray(reports) ? reports : [reports];
    for (const report of reportList) {
        if (!report) {
            continue;
        }
        report.forEach(stat => all.push(stat));
    }
    return all;
}

function sendDisplayJoin(force = false) {
    if (!ws || ws.readyState !== WebSocket.OPEN) {
        return;
    }
    const now = Date.now();
    if (!force && now - lastJoinRequest < 10000) {
        return;
    }
    lastJoinRequest = now;
    ws.send(JSON.stringify({
        type: 'display-join',
        display_id: displayId,
        user_agent: navigator.userAgent
    }));
    console.log('[LiveKit] Sent display-join message');
}

function attemptLiveKitConnect() {
    if (!pendingLivekitToken || !pendingLivekitUrl) {
        return false;
    }
    if (livekitRoom && livekitRoom.state && livekitRoom.state !== 'disconnected') {
        return true;
    }
    connectLiveKit(pendingLivekitToken, pendingLivekitUrl);
    return true;
}

async function connectLiveKit(token, url) {
    try {
        if (livekitRoom) {
            await livekitRoom.disconnect();
            livekitRoom = null;
        }

        livekitRoom = new livekit.Room({
            adaptiveStream: false,
            dynacast: false
        });

        livekitRoom.on('trackSubscribed', (track) => {
            if (track.kind === 'video') {
                attachLiveKitTrack(track);
            }
        });

        livekitRoom.on('trackUnsubscribed', () => {
            stopLiveKit();
        });

        await livekitRoom.connect(url, token, { autoSubscribe: true });
    } catch (error) {
        console.error('[LiveKit] Connection failed:', error);
        showAlert('Screen sharing connection failed', 'error');
    }
}

function attachLiveKitTrack(track) {
    livekitTrack = track;
    const video = document.getElementById('screenShareVideo');
    if (!video) {
        console.error('[LiveKit] Video element not found!');
        return;
    }

    video.srcObject = new MediaStream([track.mediaStreamTrack]);
    video.classList.add('active');

    const slideContainer = document.getElementById('slideContainer');
    slideContainer.classList.add('hidden');

    if (window.displayTelemetryInterval) {
        clearInterval(window.displayTelemetryInterval);
    }
    window.displayTelemetryInterval = setInterval(() => {
        sendDisplayTelemetry();
    }, 5000);
    sendDisplayTelemetry();
}

async function sendDisplayTelemetry() {
    if (!ws || ws.readyState !== WebSocket.OPEN || !livekitRoom || !livekitTrack) {
        return;
    }

    const stats = normalizeStats(await livekitRoom.getStats());
    const inbound = stats.find(stat =>
        stat.type === 'inbound-rtp' &&
        (stat.kind === 'video' || stat.mediaType === 'video')
    );

    let bitrate = null;
    let packetLoss = null;
    let jitter = null;

    if (inbound) {
        const now = Date.now();
        if (inbound.bytesReceived != null) {
            if (lastInboundBytes != null && lastInboundTimestamp != null) {
                const bytesDelta = inbound.bytesReceived - lastInboundBytes;
                const timeDelta = (now - lastInboundTimestamp) / 1000;
                if (timeDelta > 0) {
                    bitrate = (bytesDelta * 8) / timeDelta;
                }
            }
            lastInboundBytes = inbound.bytesReceived;
            lastInboundTimestamp = now;
        }

        if (inbound.packetsLost != null && inbound.packetsReceived != null) {
            const total = inbound.packetsLost + inbound.packetsReceived;
            if (total > 0) {
                packetLoss = inbound.packetsLost / total;
            }
        }

        if (inbound.jitter != null) {
            jitter = inbound.jitter;
        }
    }

    const settings = livekitTrack.mediaStreamTrack.getSettings();
    ws.send(JSON.stringify({
        type: 'display-telemetry',
        display_id: displayId,
        role: displayRole,
        resolution: `${settings.width}x${settings.height}`,
        frameRate: settings.frameRate,
        bitrate: bitrate,
        packetLoss: packetLoss,
        jitter: jitter
    }));
}

function stopLiveKit() {
    if (window.displayTelemetryInterval) {
        clearInterval(window.displayTelemetryInterval);
        window.displayTelemetryInterval = null;
    }

    if (livekitRoom) {
        livekitRoom.disconnect();
        livekitRoom = null;
    }

    livekitTrack = null;
    lastInboundBytes = null;
    lastInboundTimestamp = null;

    const video = document.getElementById('screenShareVideo');
    video.srcObject = null;
    video.classList.remove('active');

    document.getElementById('slideContainer').classList.remove('hidden');
}

async function init() {
    initBuzzerSound();
    // Load display mode setting
    await loadDisplayMode();
    // Get session ID from URL or default to 1
    const urlParams = new URLSearchParams(window.location.search);
    sessionId = urlParams.get('session') || 1;

    try {
        // Load initial snapshot
        const snapshot = await apiRequest(`/display/sessions/${sessionId}/snapshot`);
        updateDisplay(snapshot);

        // Connect to WebSocket
        connectWebSocket();
    } catch (error) {
        showAlert('Error loading display: ' + error.message, 'error');
    }
}

function updateDisplay(snapshot) {
    // Update banner
    document.getElementById('bannerText').textContent = snapshot.banner_text;

    // Update slide
    const slideContainer = document.getElementById('slideContainer');
    if (snapshot.current_slide) {
        slideContainer.innerHTML = `<img src="${snapshot.current_slide.png_path}" alt="Slide">`;
    } else {
        slideContainer.innerHTML = '<div class="no-slide">No slide loaded</div>';
    }

    // Update scoreboard
    updateScoreboard(snapshot.scores);

    // Update timer
    if (snapshot.timer_state) {
        document.getElementById('timerDisplay').textContent = formatTime(snapshot.timer_state.remaining_ms);
        document.getElementById('timerStatus').textContent = snapshot.timer_state.state;
    }

    // Update buzzer queue
    updateBuzzerQueue(snapshot.buzzer_queue);
}

function updateScoreboard(scores) {
    const tbody = document.getElementById('scoreboardBody');
    tbody.innerHTML = '';

    if (!scores || scores.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">No teams</td></tr>';
        return;
    }

    scores.forEach((team, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${team.team_name}</td>
            <td>${team.total}</td>
        `;
        tbody.appendChild(row);
    });
}

function updateBuzzerQueue(queue) {
    const buzzerDiv = document.getElementById('buzzerQueue');

    if (!queue || queue.length === 0) {
        buzzerDiv.innerHTML = '<div class="no-buzzes">No buzzes yet</div>';
        return;
    }

    buzzerDiv.innerHTML = '';
    queue.forEach(item => {
        const div = document.createElement('div');
        div.className = 'buzzer-item' + (item.placement === 1 ? ' first' : '');
        div.innerHTML = `
            <span>${item.placement}. ${item.team_name}</span>
            <span>${new Date(item.timestamp * 1000).toLocaleTimeString()}</span>
        `;
        buzzerDiv.appendChild(div);
    });
}

function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/display/${sessionId}`;

    ws = new WebSocket(wsUrl);

      ws.onopen = () => {
          console.log('WebSocket connected');

          if (displayMode === 'screen_share') {
              sendDisplayJoin(true);
          }
      };

    ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);

            switch (data.event) {
                case 'slide.update':
                    const slideContainer = document.getElementById('slideContainer');
                    if (data.slide) {
                        slideContainer.innerHTML = `<img src="${data.slide.png_path}" alt="Slide">`;
                    }
                    break;

                case 'timer.tick':
                    document.getElementById('timerDisplay').textContent = formatTime(data.remaining_ms);
                    document.getElementById('timerStatus').textContent = data.state;
                    break;

                case 'score.update':
                    // Reload scores
                    apiRequest(`/display/sessions/${sessionId}/snapshot`)
                        .then(snapshot => updateScoreboard(snapshot.scores));
                    break;

                case 'score.status':
                    // Heartbeat update with all team scores
                    updateScoreboard(data.scores || []);
                    break;

                case 'buzzer.update':
                case 'buzzer.results':
                    void playFirstBuzzerSound(data);
                    apiRequest(`/display/sessions/${sessionId}/snapshot`)
                        .then(snapshot => updateBuzzerQueue(snapshot.buzzer_queue));
                    break;

                case 'buzzer.status':
                    // Heartbeat update with complete buzzer state
                    updateBuzzerQueue(data.queue || []);
                    break;

                case 'buzzer.cleared':
                    // Clear buzzer queue display
                    updateBuzzerQueue([]);
                    break;

                  case 'display.approved':
                      displayRole = data.role || 'normal';
                      pendingLivekitToken = data.token;
                      pendingLivekitUrl = data.livekit_url;
                      if (displayMode === 'screen_share') {
                          attemptLiveKitConnect();
                      }
                      break;
                  case 'presenter.started':
                      if (displayMode === 'screen_share') {
                          if (!attemptLiveKitConnect()) {
                              sendDisplayJoin();
                          }
                      }
                      break;
                  case 'presenter.heartbeat':
                      if (displayMode === 'screen_share') {
                          if (!attemptLiveKitConnect()) {
                              sendDisplayJoin();
                          }
                      }
                      break;

                case 'display.error':
                    showAlert(data.message || 'Display approval failed', 'error');
                    break;

                case 'presenter.stopped':
                case 'presenter.disconnected':
                    // Presenter stopped sharing
                    stopLiveKit();
                    break;

                case 'settings.update':
                    // Display mode changed
                    if (data.setting_key === 'display_mode') {
                        displayMode = 'png_slides';
                        stopLiveKit();
                    }
                    break;
            }
        } catch (error) {
            console.error('Error parsing WebSocket message:', error);
        }
    };

    ws.onerror = (error) => {
        console.error('WebSocket error:', error);
    };

    ws.onclose = () => {
        console.log('WebSocket closed, reconnecting...');
        setTimeout(connectWebSocket, 3000);
    };
}

// Initialize on load
window.addEventListener('load', init);
</script>
{% endblock %}
